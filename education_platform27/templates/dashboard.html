{% extends "base.html" %}
{% block title %}Главная{% endblock %}

{% block extra_css %}
<style>
.dashboard-card {
    background: var(--white);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    cursor: pointer;
    margin-bottom: 1rem;
    border-left: 4px solid #4361ee;
}

.dashboard-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.dashboard-card.incomplete {
    border-left-color: #f59e0b;
    background: linear-gradient(to right, #fffbeb 0%, #ffffff 100%);
}

.dashboard-card.completed {
    border-left-color: #10b981;
}

.dashboard-card h5 {
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
    color: var(--text);
}

.dashboard-card .meta {
    font-size: 0.875rem;
    color: var(--text-light);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.dashboard-card .badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}

.badge-warning {
    background: #fef3c7;
    color: #92400e;
}

.badge-success {
    background: #d1fae5;
    color: #065f46;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    margin-top: 2rem;
}

.section-header h2 {
    margin: 0;
    font-size: 1.5rem;
}

.empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-light);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.3;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.dashboard-card {
    animation: fadeInUp 0.5s ease;
}

.dashboard-card:nth-child(1) { animation-delay: 0.1s; }
.dashboard-card:nth-child(2) { animation-delay: 0.2s; }
.dashboard-card:nth-child(3) { animation-delay: 0.3s; }
.dashboard-card:nth-child(4) { animation-delay: 0.4s; }
.dashboard-card:nth-child(5) { animation-delay: 0.5s; }
</style>
{% endblock %}

{% block content %}
<h1>Добро пожаловать, {{ current_user.username }}</h1>

{% if current_user.is_admin() %}
<div class="card" style="margin-bottom: 1.5rem; border-left: 4px solid #e94560;">
    <h2><i class="bi bi-shield-lock"></i> Панель администратора</h2>
    <p>Вы вошли как администратор платформы.</p>
    <a href="{{ url_for('admin_panel') }}" class="btn btn-primary">Перейти в админ-панель</a>
</div>
{% endif %}

{% if current_user.is_cook() %}
<div class="card" style="margin-bottom: 1.5rem; border-left: 4px solid #fda085;">
    <h2><i class="bi bi-egg-fried"></i> Кабинет повара</h2>
    <p>Проверяйте и одобряйте рецепты пользователей.</p>
    <a href="{{ url_for('cook_profile') }}" class="btn btn-primary">Перейти в кабинет повара</a>
</div>
{% endif %}

{% if current_user.is_student() %}
<div class="stats-grid">
    <div class="stat-card">
        <h3>Всего тестов пройдено</h3>
        <div class="value">{{ completed_tests|length }}</div>
    </div>
    <div class="stat-card">
        <h3>Тренировок выполнено</h3>
        <div class="value">{{ completed_pe|length }}</div>
    </div>
    <div class="stat-card">
        <h3>Средняя оценка</h3>
        <div class="value">
            {% set scores = completed_tests|map(attribute='score')|list %}
            {% if scores %}
                {{ (scores|sum / scores|length)|round|int }}%
            {% else %}
                -
            {% endif %}
        </div>
    </div>
</div>

<!-- Незавершенные тесты -->
{% if incomplete_tests %}
<div class="section-header">
    <h2><i class="bi bi-clock-history"></i> Незавершенные тесты</h2>
</div>
<div class="row">
    {% for test in incomplete_tests %}
    <div class="col-md-6 mb-3">
        <div class="dashboard-card incomplete" onclick="continueTest({{ test.id }})">
            <h5><i class="bi bi-file-text"></i> {{ test.subject }} - {{ test.topic }}</h5>
            <div class="meta">
                <span class="badge badge-warning">Не завершен</span>
                <span>{{ test.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Незавершенные тренировки -->
{% if incomplete_pe %}
<div class="section-header">
    <h2><i class="bi bi-clock-history"></i> Незавершенные тренировки</h2>
</div>
<div class="row">
    {% for pe in incomplete_pe %}
    <div class="col-md-6 mb-3">
        <div class="dashboard-card incomplete" onclick="continuePE({{ pe.id }})">
            <h5><i class="bi bi-lightning"></i> {{ pe.exercise_type }}</h5>
            <div class="meta">
                <span class="badge badge-warning">Не завершена</span>
                <span>{{ pe.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Завершенные тесты -->
{% if completed_tests %}
<div class="section-header">
    <h2><i class="bi bi-check-circle"></i> Последние тесты</h2>
</div>
<div class="row">
    {% for test in completed_tests %}
    <div class="col-md-6 mb-3">
        <div class="dashboard-card completed">
            <h5><i class="bi bi-file-text"></i> {{ test.subject }} - {{ test.topic }}</h5>
            <div class="meta">
                <span class="badge badge-success">{{ test.score }}%</span>
                <span>{{ test.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Завершенные тренировки -->
{% if completed_pe %}
<div class="section-header">
    <h2><i class="bi bi-check-circle"></i> Последние тренировки</h2>
</div>
<div class="row">
    {% for pe in completed_pe %}
    <div class="col-md-6 mb-3">
        <div class="dashboard-card completed">
            <h5><i class="bi bi-lightning"></i> {{ pe.exercise_type }}</h5>
            <div class="meta">
                <span class="badge badge-success">{{ pe.score }}%</span>
                <span>Повторений: {{ pe.repetitions }}</span>
                <span>{{ pe.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{% if not incomplete_tests and not incomplete_pe and not completed_tests and not completed_pe %}
<div class="empty-state">
    <i class="bi bi-inbox"></i>
    <p>Пока нет активности. Начните с создания теста или тренировки!</p>
</div>
{% endif %}

{% endif %}

{% if current_user.is_teacher() %}
<div class="card">
    <h2>Панель учителя</h2>
    <p>Управляйте учениками и следите за их прогрессом.</p>
    <a href="{{ url_for('teacher_profile') }}" class="btn btn-primary">Панель управления</a>
    <a href="{{ url_for('teacher_students') }}" class="btn btn-primary" style="margin-left: 0.5rem;">Мои ученики</a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function continueTest(testId) {
    window.location.href = `/test/${testId}/continue`;
}

function continuePE(peId) {
    window.location.href = `/pe/${peId}/continue`;
}
</script>
{% endblock %}
