{% extends "base.html" %}
{% block title %}{{ test.subject }}: {{ test.topic }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/test.css') }}">
{% endblock %}

{% block content %}
<div class="test-wrapper">
    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π -->
    <div class="test-sidebar">
        <div class="test-info">
            <h3>{{ test.subject }}</h3>
            <p>{{ test.topic }}</p>
            <div class="progress-info">
                <span id="answeredCount">0</span> –∏–∑ {{ test_data.questions|length }}
            </div>
        </div>
        
        <div class="questions-nav">
            {% for i in range(test_data.questions|length) %}
            <button class="question-nav-btn" data-question="{{ i }}" onclick="goToQuestion({{ i }})">
                <span class="q-number">{{ i + 1 }}</span>
                <span class="q-status" id="status-{{ i }}">‚óã</span>
            </button>
            {% endfor %}
        </div>
        
        <button class="btn btn-primary btn-finish" onclick="showReviewModal()" style="width: 100%; margin-top: auto;">
            –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç
        </button>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ -->
    <div class="test-main">
        {% for question in test_data.questions %}
        {% set i = loop.index0 %}
        <div class="question-slide" id="question-{{ i }}" style="display: {{ 'block' if i == 0 else 'none' }}">
            <div class="question-header">
                <span class="question-num">–í–æ–ø—Ä–æ—Å {{ i + 1 }} –∏–∑ {{ test_data.questions|length }}</span>
            </div>
            
            <div class="question-content">
                <h2 class="math-content">{{ question.question }}</h2>
                
                <div class="options-list">
                    {% for option in question.options %}
                    {% set j = loop.index0 %}
                    <label class="option-card">
                        <input type="radio" name="question_{{ i }}" value="{{ j }}" onchange="markAnswered({{ i }})">
                        <div class="option-content">
                            <span class="option-letter">{{ '–ê–ë–í–ì'[j] }}</span>
                            <span class="option-text math-content">{{ option }}</span>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>
            
            <div class="question-footer">
                <button class="btn btn-secondary" onclick="prevQuestion()" {% if i == 0 %}disabled{% endif %}>
                    ‚Üê –ù–∞–∑–∞–¥
                </button>
                <button class="btn btn-primary" onclick="nextQuestion()">
                    {% if i == test_data.questions|length - 1 %}
                    –ó–∞–≤–µ—Ä—à–∏—Ç—å ‚Üí
                    {% else %}
                    –î–∞–ª–µ–µ ‚Üí
                    {% endif %}
                </button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
<div id="reviewModal" class="modal">
    <div class="modal-content">
        <h2>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã</h2>
        <p style="margin-bottom: 20px;">–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π</p>
        <div class="review-grid" id="reviewGrid"></div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeReviewModal()">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–µ—Å—Ç—É</button>
            <button class="btn btn-primary" onclick="confirmSubmit()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
<div id="confirmModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <h2>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∫—É</h2>
        <p style="font-size: 1.1rem;">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç? –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–∑–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç—ã –±—É–¥–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.</p>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeConfirmModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" onclick="submitTest()">–î–∞, –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
<div id="resultModal" class="modal">
    <div class="modal-content modal-result">
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞</h2>
        <div class="score-display">
            <div class="score-circle">
                <span id="scoreValue">0%</span>
            </div>
            <p id="resultText" style="font-size: 1.2rem;"></p>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="location.href='{{ url_for('tests') }}'">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–µ—Å—Ç</button>
            <button class="btn btn-primary" onclick="showDetailedResults()">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
        </div>
    </div>
</div>

<!-- –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
<div id="detailedResults" style="display: none;">
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
            <h1 style="margin: 0;">–î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</h1>
            <button class="btn btn-secondary" onclick="location.href='{{ url_for('dashboard') }}'">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
        </div>
        
        <div class="results-summary">
            <div class="summary-item">
                <span class="summary-label">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö:</span>
                <span class="summary-value correct" id="correctCount">0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö:</span>
                <span class="summary-value incorrect" id="incorrectCount">0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞:</span>
                <span class="summary-value" id="finalScore">0%</span>
            </div>
        </div>
        
        <div id="detailedAnswers"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- MathJax –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–æ—Ä–º—É–ª -->
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    processEscapes: true
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<script>
const testData = {{ test_data|tojson }};
let currentQuestion = 0;
let answers = {};

function goToQuestion(index) {
    document.querySelectorAll('.question-slide').forEach(q => q.style.display = 'none');
    document.getElementById('question-' + index).style.display = 'block';
    
    document.querySelectorAll('.question-nav-btn').forEach(btn => btn.classList.remove('current'));
    document.querySelector(`[data-question="${index}"]`).classList.add('current');
    
    currentQuestion = index;
    
    // –†–µ–Ω–¥–µ—Ä–∏–º –º–∞—Ç–µ–º–∞—Ç–∏–∫—É –¥–ª—è –Ω–æ–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    if (window.MathJax) {
        MathJax.typesetPromise();
    }
}

function nextQuestion() {
    if (currentQuestion < testData.questions.length - 1) {
        goToQuestion(currentQuestion + 1);
    } else {
        showReviewModal();
    }
}

function prevQuestion() {
    if (currentQuestion > 0) {
        goToQuestion(currentQuestion - 1);
    }
}

function markAnswered(questionIndex) {
    const selected = document.querySelector(`input[name="question_${questionIndex}"]:checked`);
    if (selected) {
        answers[questionIndex] = parseInt(selected.value);
        document.getElementById('status-' + questionIndex).textContent = '‚úì';
        document.querySelector(`[data-question="${questionIndex}"]`).classList.add('answered');
        updateAnsweredCount();
    }
}

function updateAnsweredCount() {
    document.getElementById('answeredCount').textContent = Object.keys(answers).length;
}

function showReviewModal() {
    const grid = document.getElementById('reviewGrid');
    grid.innerHTML = '';
    
    for (let i = 0; i < testData.questions.length; i++) {
        const item = document.createElement('div');
        item.className = 'review-item ' + (answers[i] !== undefined ? 'answered' : 'unanswered');
        item.textContent = i + 1;
        item.onclick = () => {
            closeReviewModal();
            goToQuestion(i);
        };
        grid.appendChild(item);
    }
    
    document.getElementById('reviewModal').classList.add('active');
}

function closeReviewModal() {
    document.getElementById('reviewModal').classList.remove('active');
}

function confirmSubmit() {
    const unanswered = testData.questions.length - Object.keys(answers).length;
    if (unanswered > 0) {
        alert(`–í—ã –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ ${unanswered} –≤–æ–ø—Ä–æ—Å(–æ–≤). –í–µ—Ä–Ω–∏—Ç–µ—Å—å –∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã.`);
        return;
    }
    closeReviewModal();
    document.getElementById('confirmModal').classList.add('active');
}

function closeConfirmModal() {
    document.getElementById('confirmModal').classList.remove('active');
}

function submitTest() {
    closeConfirmModal();
    
    fetch('{{ url_for("check_test", test_id=test.id) }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ answers: answers })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('scoreValue').textContent = data.score + '%';
        document.getElementById('resultText').textContent = 
            `–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${data.correct} –∏–∑ ${data.total}`;
        
        document.getElementById('correctCount').textContent = data.correct;
        document.getElementById('incorrectCount').textContent = data.total - data.correct;
        document.getElementById('finalScore').textContent = data.score + '%';
        
        window.testResults = data;
        document.getElementById('resultModal').classList.add('active');
    });
}

function showDetailedResults() {
    document.getElementById('resultModal').classList.remove('active');
    document.querySelector('.test-wrapper').style.display = 'none';
    document.getElementById('detailedResults').style.display = 'block';
    
    const container = document.getElementById('detailedAnswers');
    container.innerHTML = '';
    
    testData.questions.forEach((question, i) => {
        const userAnswer = answers[i];
        const correctAnswer = question.correct;
        const isCorrect = userAnswer === correctAnswer;
        
        const div = document.createElement('div');
        div.className = 'detailed-question ' + (isCorrect ? 'correct' : 'incorrect');
        
        const russianLetters = '–ê–ë–í–ì';
        
        let html = `
            <h3>
                –í–æ–ø—Ä–æ—Å ${i + 1}
                <span class="result-badge ${isCorrect ? 'correct' : 'incorrect'}">
                    ${isCorrect ? '‚úì –ü—Ä–∞–≤–∏–ª—å–Ω–æ' : '‚úó –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ'}
                </span>
            </h3>
            <p class="math-content">${question.question}</p>
        `;
        
        question.options.forEach((option, j) => {
            let className = '';
            let prefix = russianLetters[j] + '. ';
            
            if (j === correctAnswer) {
                className = 'answer-option correct-answer';
                prefix = '‚úì ' + prefix + ' (–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç) ';
            } else if (j === userAnswer && !isCorrect) {
                className = 'answer-option user-incorrect';
                prefix = '‚úó ' + prefix + ' (–í–∞—à –æ—Ç–≤–µ—Ç) ';
            } else {
                className = 'answer-option';
            }
            
            html += `<div class="${className}"><span class="math-content">${prefix}${option}</span></div>`;
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—è—Å–Ω–µ–Ω–∏–µ –¥–ª—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
        if (!isCorrect) {
            let explanation = question.explanation;
            
            if (!explanation || explanation.trim() === '') {
                explanation = `
                    <strong>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</strong> ${russianLetters[correctAnswer]}. ${question.options[correctAnswer]}<br><br>
                    <strong>–í–∞—à –æ—Ç–≤–µ—Ç –±—ã–ª –Ω–µ–≤–µ—Ä–Ω—ã–º, –ø–æ—Ç–æ–º—É —á—Ç–æ:</strong><br>
                    –í—ã –≤—ã–±—Ä–∞–ª–∏ –≤–∞—Ä–∏–∞–Ω—Ç ${russianLetters[userAnswer]}: "${question.options[userAnswer]}", 
                    –Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —è–≤–ª—è–µ—Ç—Å—è –≤–∞—Ä–∏–∞–Ω—Ç ${russianLetters[correctAnswer]}.
                `;
            }
            
            html += `
                <div class="explanation">
                    <strong>üí° –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ:</strong>
                    <div class="explanation-text math-content">${explanation}</div>
                </div>
            `;
        }
        
        div.innerHTML = html;
        container.appendChild(div);
    });
    
    // –†–µ–Ω–¥–µ—Ä–∏–º –º–∞—Ç–µ–º–∞—Ç–∏–∫—É –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    if (window.MathJax) {
        MathJax.typesetPromise();
    }
    
    window.scrollTo(0, 0);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
goToQuestion(0);

// –†–µ–Ω–¥–µ—Ä–∏–º –º–∞—Ç–µ–º–∞—Ç–∏–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load', function() {
    if (window.MathJax) {
        MathJax.typesetPromise();
    }
});
</script>
{% endblock %}
