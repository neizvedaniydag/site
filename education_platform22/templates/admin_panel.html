{% extends "base.html" %}
{% block title %}Админ-панель{% endblock %}

{% block extra_css %}
<style>
    .admin-container { max-width: 1400px; margin: 0 auto; }
    .admin-header {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        color: white; padding: 2rem; border-radius: 12px;
        margin-bottom: 2rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .admin-avatar {
        width: 100px; height: 100px; border-radius: 50%;
        background: rgba(255,255,255,0.1); display: flex;
        align-items: center; justify-content: center;
        font-size: 2.5rem; margin: 0 auto 1rem; border: 3px solid #e94560;
    }
    .stats-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem; margin-bottom: 2rem;
    }
    .stat-card {
        background: white; padding: 1.25rem; border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center;
        border-left: 4px solid #e94560;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .stat-value { font-size: 2rem; font-weight: bold; color: #1a1a2e; }
    .stat-label { color: #666; font-size: 0.85rem; }
    .tabs {
        display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;
    }
    .tab-btn {
        padding: 0.6rem 1.2rem; border: 2px solid #ddd; background: white;
        border-radius: 8px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s;
        position: relative;
    }
    .tab-btn:hover { border-color: #e94560; color: #e94560; }
    .tab-btn.active { background: #1a1a2e; color: white; border-color: #1a1a2e; }
    .tab-badge {
        position: absolute; top: -8px; right: -8px; background: #e94560;
        color: white; border-radius: 50%; width: 22px; height: 22px;
        font-size: 0.75rem; display: flex; align-items: center; justify-content: center;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .section-card {
        background: white; padding: 1.5rem; border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 1.5rem;
    }
    .section-card h3 { margin-top: 0; color: #1a1a2e; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.75rem; }
    .user-row {
        display: flex; justify-content: space-between; align-items: center;
        padding: 0.75rem; border-bottom: 1px solid #f0f0f0; transition: background 0.2s;
    }
    .user-row:hover { background: #f8f9fa; }
    .user-row:last-child { border-bottom: none; }
    .user-info { flex: 1; }
    .user-info strong { color: #333; }
    .user-info small { color: #888; }
    .user-actions { display: flex; gap: 0.4rem; flex-wrap: wrap; }
    .btn-sm {
        padding: 0.3rem 0.6rem; border: none; border-radius: 4px;
        cursor: pointer; font-size: 0.8rem; color: white;
    }
    .btn-approve { background: #10b981; }
    .btn-approve:hover { background: #059669; }
    .btn-reject { background: #ef4444; }
    .btn-reject:hover { background: #dc2626; }
    .btn-ban { background: #f59e0b; }
    .btn-ban:hover { background: #d97706; }
    .btn-edit { background: #3b82f6; }
    .btn-edit:hover { background: #2563eb; }
    .btn-delete { background: #dc2626; }
    .btn-delete:hover { background: #b91c1c; }
    .btn-role { background: #8b5cf6; }
    .btn-role:hover { background: #7c3aed; }
    .badge-role {
        display: inline-block; padding: 0.15rem 0.5rem; border-radius: 10px;
        font-size: 0.75rem; font-weight: 500; color: white;
    }
    .badge-student { background: #3b82f6; }
    .badge-teacher { background: #f5576c; }
    .badge-cook { background: #f6d365; color: #333; }
    .badge-admin { background: #1a1a2e; }
    .badge-banned { background: #ef4444; }
    .badge-pending-approval { background: #f59e0b; }
    .notif-item {
        padding: 0.75rem; border-left: 3px solid #e94560;
        margin-bottom: 0.5rem; background: #fff5f5; border-radius: 0 6px 6px 0;
    }
    .notif-item .notif-time { font-size: 0.8rem; color: #999; }
    .log-item { padding: 0.5rem 0; border-bottom: 1px solid #f5f5f5; font-size: 0.9rem; }
    .log-item .log-time { color: #999; font-size: 0.8rem; }
    .log-item .log-action { color: #333; }
    .empty-state { text-align: center; padding: 2rem; color: #999; }
    .search-box {
        width: 100%; padding: 0.6rem 1rem; border: 1px solid #ddd;
        border-radius: 8px; margin-bottom: 1rem; font-size: 0.95rem;
    }
    .modal-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;
    }
    .modal-overlay.show { display: flex; }
    .modal-box {
        background: white; padding: 2rem; border-radius: 12px;
        max-width: 400px; width: 90%;
    }
    .modal-box h3 { margin-top: 0; }
    .modal-box input, .modal-box select {
        width: 100%; padding: 0.6rem; border: 1px solid #ddd;
        border-radius: 6px; margin-bottom: 1rem;
    }
    .modal-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <div class="admin-avatar"><i class="bi bi-shield-lock"></i></div>
        <h1 style="text-align:center;margin:0;">Админ-панель</h1>
        <p style="text-align:center;margin:0.5rem 0 0;opacity:0.8;">{{ current_user.nickname or current_user.username }} | Владелец проекта</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card" onclick="switchTab('users')">
            <div class="stat-value">{{ total_users }}</div>
            <div class="stat-label">Всего пользователей</div>
        </div>
        <div class="stat-card" onclick="switchTab('users')">
            <div class="stat-value">{{ total_students }}</div>
            <div class="stat-label">Учеников</div>
        </div>
        <div class="stat-card" onclick="switchTab('users')">
            <div class="stat-value">{{ total_teachers }}</div>
            <div class="stat-label">Учителей</div>
        </div>
        <div class="stat-card" onclick="switchTab('users')">
            <div class="stat-value">{{ total_cooks }}</div>
            <div class="stat-label">Поваров</div>
        </div>
        <div class="stat-card" onclick="window.location.href='{{ url_for('recipes') }}'">
            <div class="stat-value">{{ total_recipes }}</div>
            <div class="stat-label">Рецептов</div>
        </div>
        <div class="stat-card" onclick="window.location.href='{{ url_for('recipes') }}'">
            <div class="stat-value">{{ pending_recipes }}</div>
            <div class="stat-label">Рецептов на проверке</div>
        </div>
        <div class="stat-card" onclick="switchTab('logs')">
            <div class="stat-value">{{ total_tests }}</div>
            <div class="stat-label">Тестов пройдено</div>
        </div>
    </div>

    <!-- Табы -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('pending')">
            Заявки
            {% if pending_users %}<span class="tab-badge">{{ pending_users|length }}</span>{% endif %}
        </button>
        <button class="tab-btn" onclick="switchTab('notifications')">
            Уведомления
            {% if notifications %}<span class="tab-badge">{{ notifications|length }}</span>{% endif %}
        </button>
        <button class="tab-btn" onclick="switchTab('users')">Все пользователи</button>
        <button class="tab-btn" onclick="switchTab('logs')">Лог активности</button>
    </div>

    <!-- Заявки на регистрацию -->
    <div class="tab-content active" id="tab-pending">
        <div class="section-card">
            <h3><i class="bi bi-person-plus"></i> Заявки на регистрацию</h3>
            {% if pending_users %}
                {% for user in pending_users %}
                <div class="user-row" id="pending-user-{{ user.id }}">
                    <div class="user-info">
                        <strong>{{ user.username }}</strong> (@{{ user.nickname }})
                        <br><small>{{ user.email }} |
                        <span class="badge-role {% if user.role == 'teacher' %}badge-teacher{% elif user.role == 'cook' %}badge-cook{% endif %}">
                            {% if user.role == 'teacher' %}Учитель{% elif user.role == 'cook' %}Повар{% endif %}
                        </span>
                        | {{ user.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                    </div>
                    <div class="user-actions">
                        <button class="btn-sm btn-approve" onclick="approveUser({{ user.id }})"><i class="bi bi-check-lg"></i> Одобрить</button>
                        <button class="btn-sm btn-reject" onclick="rejectUser({{ user.id }})"><i class="bi bi-x-lg"></i> Отклонить</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state"><i class="bi bi-check-circle" style="font-size:2rem;"></i><p>Нет заявок на рассмотрение</p></div>
            {% endif %}
        </div>
    </div>

    <!-- Уведомления -->
    <div class="tab-content" id="tab-notifications">
        <div class="section-card">
            <h3><i class="bi bi-bell"></i> Уведомления
                {% if notifications %}
                <button class="btn-sm btn-edit" style="float:right;" onclick="readAllNotifications()">Прочитать все</button>
                {% endif %}
            </h3>
            {% if notifications %}
                {% for notif in notifications %}
                <div class="notif-item">
                    <div>{{ notif.message }}</div>
                    <div class="notif-time">{{ notif.created_at.strftime('%d.%m.%Y %H:%M') }}</div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state"><p>Нет новых уведомлений</p></div>
            {% endif %}
        </div>
    </div>

    <!-- Все пользователи -->
    <div class="tab-content" id="tab-users">
        <div class="section-card">
            <h3><i class="bi bi-people"></i> Все пользователи ({{ total_users }})</h3>
            <input type="text" class="search-box" id="userSearch" placeholder="Поиск по имени, никнейму или email..." oninput="filterUsers()">
            <div id="usersList">
            {% for user in users %}
                <div class="user-row user-searchable" data-search="{{ user.username|lower }} {{ user.nickname|lower if user.nickname else '' }} {{ user.email|lower }}" id="user-row-{{ user.id }}">
                    <div class="user-info">
                        <strong>{{ user.username }}</strong>
                        <span style="color:#888;">(@{{ user.nickname or user.username }})</span>
                        <span class="badge-role
                            {% if user.role == 'admin' %}badge-admin
                            {% elif user.role == 'teacher' %}badge-teacher
                            {% elif user.role == 'cook' %}badge-cook
                            {% else %}badge-student{% endif %}">
                            {% if user.role == 'admin' %}Админ{% elif user.role == 'teacher' %}Учитель{% elif user.role == 'cook' %}Повар{% else %}Ученик{% endif %}
                        </span>
                        {% if user.is_banned %}<span class="badge-role badge-banned">Заблокирован</span>{% endif %}
                        {% if not user.is_approved %}<span class="badge-role badge-pending-approval">Ожидает</span>{% endif %}
                        <br><small>{{ user.email }} | ID: {{ user.id }} | Рег: {{ user.created_at.strftime('%d.%m.%Y') }}</small>
                    </div>
                    <div class="user-actions">
                        {% if not user.is_admin() %}
                        <button class="btn-sm btn-edit" onclick="openNicknameModal({{ user.id }}, '{{ user.nickname or user.username }}')" title="Изменить никнейм"><i class="bi bi-pencil"></i></button>
                        <button class="btn-sm btn-role" onclick="openRoleModal({{ user.id }}, '{{ user.role }}')" title="Изменить роль"><i class="bi bi-arrow-repeat"></i></button>
                        <button class="btn-sm btn-ban" onclick="toggleBan({{ user.id }})" title="Бан/Разбан"><i class="bi bi-slash-circle"></i></button>
                        <button class="btn-sm btn-delete" onclick="deleteUser({{ user.id }}, '{{ user.username }}')" title="Удалить"><i class="bi bi-trash"></i></button>
                        {% else %}
                        <span style="color:#999;font-size:0.85rem;">Владелец</span>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
            </div>
        </div>
    </div>

    <!-- Лог активности -->
    <div class="tab-content" id="tab-logs">
        <div class="section-card">
            <h3><i class="bi bi-journal-text"></i> Лог активности</h3>
            {% if recent_logs %}
                {% for log in recent_logs %}
                <div class="log-item">
                    <span class="log-action">
                        {% if log.user %}
                        <strong>{{ log.user.nickname or log.user.username }}</strong>:
                        {% endif %}
                        {{ log.details or log.action }}
                    </span>
                    <span class="log-time"> | {{ log.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state"><p>Лог пуст</p></div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модалка: Изменить никнейм -->
<div class="modal-overlay" id="nicknameModal">
    <div class="modal-box">
        <h3>Изменить никнейм</h3>
        <input type="text" id="newNickname" placeholder="Новый никнейм">
        <input type="hidden" id="nicknameUserId">
        <div class="modal-actions">
            <button class="btn-sm btn-reject" onclick="closeModal('nicknameModal')">Отмена</button>
            <button class="btn-sm btn-approve" onclick="saveNickname()">Сохранить</button>
        </div>
    </div>
</div>

<!-- Модалка: Изменить роль -->
<div class="modal-overlay" id="roleModal">
    <div class="modal-box">
        <h3>Изменить роль</h3>
        <select id="newRole">
            <option value="student">Ученик</option>
            <option value="teacher">Учитель</option>
            <option value="cook">Повар</option>
        </select>
        <input type="hidden" id="roleUserId">
        <div class="modal-actions">
            <button class="btn-sm btn-reject" onclick="closeModal('roleModal')">Отмена</button>
            <button class="btn-sm btn-approve" onclick="saveRole()">Сохранить</button>
        </div>
    </div>
</div>

<script>
function switchTab(name) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + name).classList.add('active');
    event.target.closest('.tab-btn').classList.add('active');
}

function filterUsers() {
    const q = document.getElementById('userSearch').value.toLowerCase();
    document.querySelectorAll('.user-searchable').forEach(row => {
        row.style.display = row.dataset.search.includes(q) ? '' : 'none';
    });
}

function apiCall(url, method, body) {
    return fetch(url, {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: body ? JSON.stringify(body) : undefined
    }).then(r => r.json());
}

function approveUser(id) {
    apiCall('/admin/approve-user/' + id, 'POST').then(data => {
        if (data.success) { location.reload(); }
        else { alert(data.error); }
    });
}

function rejectUser(id) {
    if (!confirm('Отклонить заявку? Аккаунт будет удалён.')) return;
    apiCall('/admin/reject-user/' + id, 'POST').then(data => {
        if (data.success) { location.reload(); }
        else { alert(data.error); }
    });
}

function toggleBan(id) {
    if (!confirm('Заблокировать/разблокировать пользователя?')) return;
    apiCall('/admin/ban-user/' + id, 'POST').then(data => {
        if (data.success) { location.reload(); }
        else { alert(data.error); }
    });
}

function deleteUser(id, name) {
    if (!confirm('Удалить пользователя ' + name + '? Это действие необратимо!')) return;
    apiCall('/admin/delete-user/' + id, 'DELETE').then(data => {
        if (data.success) { location.reload(); }
        else { alert(data.error); }
    });
}

function openNicknameModal(id, current) {
    document.getElementById('nicknameUserId').value = id;
    document.getElementById('newNickname').value = current;
    document.getElementById('nicknameModal').classList.add('show');
}

function openRoleModal(id, current) {
    document.getElementById('roleUserId').value = id;
    document.getElementById('newRole').value = current;
    document.getElementById('roleModal').classList.add('show');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('show');
}

function saveNickname() {
    const id = document.getElementById('nicknameUserId').value;
    const nickname = document.getElementById('newNickname').value.trim();
    if (!nickname) { alert('Введите никнейм'); return; }
    apiCall('/admin/change-nickname/' + id, 'POST', {nickname: nickname}).then(data => {
        if (data.success) { closeModal('nicknameModal'); location.reload(); }
        else { alert(data.error); }
    });
}

function saveRole() {
    const id = document.getElementById('roleUserId').value;
    const role = document.getElementById('newRole').value;
    apiCall('/admin/change-role/' + id, 'POST', {role: role}).then(data => {
        if (data.success) { closeModal('roleModal'); location.reload(); }
        else { alert(data.error); }
    });
}

function readAllNotifications() {
    apiCall('/admin/notifications/read-all', 'POST').then(data => {
        if (data.success) { location.reload(); }
    });
}

// Закрытие модалки по клику на оверлей
document.querySelectorAll('.modal-overlay').forEach(m => {
    m.addEventListener('click', function(e) {
        if (e.target === this) this.classList.remove('show');
    });
});
</script>
{% endblock %}
