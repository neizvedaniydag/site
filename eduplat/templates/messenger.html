{% extends "base.html" %}
{% block title %}–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä{% endblock %}

{% block extra_css %}
<style>
    .messenger-container {
        display: flex;
        height: calc(100vh - 200px);
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        background: #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .conversations-list {
        width: 300px;
        border-right: 1px solid #e0e0e0;
        overflow-y: auto;
        background: #f8f9fa;
    }
    
    .conversations-header {
        padding: 1rem;
        background: #3498db;
        color: white;
        font-weight: bold;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .conversation-item {
        padding: 1rem;
        border-bottom: 1px solid #e0e0e0;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .conversation-item:hover {
        background: #e9ecef;
    }
    
    .conversation-item.active {
        background: #d0e8ff;
        border-left: 4px solid #3498db;
    }
    
    .conversation-info {
        flex: 1;
    }
    
    .conversation-username {
        font-weight: bold;
        color: #333;
        margin-bottom: 0.25rem;
    }
    
    .conversation-preview {
        font-size: 0.9rem;
        color: #666;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .conversation-time {
        font-size: 0.75rem;
        color: #999;
        margin-top: 0.25rem;
    }
    
    .unread-badge {
        background: #e74c3c;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: bold;
        margin-left: 0.5rem;
    }
    
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .chat-header {
        padding: 1rem;
        background: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
        font-weight: bold;
        color: #333;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: #ffffff;
    }
    
    .message {
        margin-bottom: 1rem;
        display: flex;
        flex-direction: column;
    }
    
    .message.sent {
        align-items: flex-end;
    }
    
    .message.received {
        align-items: flex-start;
    }
    
    .message-bubble {
        max-width: 70%;
        padding: 0.75rem 1rem;
        border-radius: 18px;
        word-wrap: break-word;
    }
    
    .message.sent .message-bubble {
        background: #3498db;
        color: white;
        border-bottom-right-radius: 4px;
    }
    
    .message.received .message-bubble {
        background: #e9ecef;
        color: #333;
        border-bottom-left-radius: 4px;
    }
    
    .message-time {
        font-size: 0.75rem;
        color: #999;
        margin-top: 0.25rem;
        padding: 0 0.5rem;
    }
    
    .chat-input-area {
        padding: 1rem;
        border-top: 1px solid #e0e0e0;
        background: #f8f9fa;
        display: flex;
        gap: 0.5rem;
    }
    
    .chat-input {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 20px;
        outline: none;
    }
    
    .chat-input:focus {
        border-color: #3498db;
    }
    
    .send-btn {
        padding: 0.75rem 1.5rem;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .send-btn:hover {
        background: #2980b9;
    }
    
    .send-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    
    .empty-chat {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #999;
        font-size: 1.1rem;
    }
    
    .no-conversations {
        padding: 2rem;
        text-align: center;
        color: #999;
    }
    
    #searchResults {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #searchResults .conversation-item {
        border-bottom: 1px solid #eee;
    }
    
    #searchResults .conversation-item:last-child {
        border-bottom: none;
    }

    #fileInput {
        display: none;
    }

    .file-attachment-display {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: #f0f7ff;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        border: 1px solid #cce5ff;
    }

    .file-attachment-display i {
        font-size: 2rem;
        color: #3498db;
    }

    .file-attachment-info {
        flex: 1;
    }

    .file-attachment-name {
        font-weight: bold;
        color: #333;
        word-break: break-word;
    }

    .file-attachment-size {
        font-size: 0.85rem;
        color: #666;
        margin-top: 0.25rem;
    }

    .file-attachment-remove {
        background: transparent;
        border: none;
        color: #e74c3c;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 0;
        transition: transform 0.2s;
    }

    .file-attachment-remove:hover {
        transform: scale(1.2);
    }

    .message-reactions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        margin-top: 0.5rem;
        font-size: 0.85rem;
    }

    .reaction-button {
        background: #f0f0f0;
        border: 1px solid #d0d0d0;
        border-radius: 16px;
        padding: 0.25rem 0.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 1rem;
        transition: all 0.2s;
    }

    .reaction-button:hover {
        background: #e0e0e0;
        transform: scale(1.1);
    }

    .reaction-button.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }

    .reaction-count {
        font-size: 0.8rem;
        line-height: 1;
    }

    .emoji-picker-btn {
        padding: 0.75rem 1rem;
        background: #f0f0f0;
        color: #333;
        border: 1px solid #ddd;
        border-radius: 20px;
        cursor: pointer;
        font-size: 1.2rem;
        transition: background 0.2s;
    }

    .emoji-picker-btn:hover {
        background: #e0e0e0;
    }

    .emoji-picker {
        position: fixed;
        bottom: auto;
        right: 20px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        max-width: 350px;
        display: none;
    }

    .emoji-picker.active {
        display: block;
    }

    .emoji-picker-header {
        padding: 0.75rem;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .emoji-picker-close {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: #666;
    }

    .emoji-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 0.5rem;
        padding: 0.75rem;
        max-height: 300px;
        overflow-y: auto;
    }

    .emoji-item {
        font-size: 1.5rem;
        cursor: pointer;
        text-align: center;
        padding: 0.5rem;
        border-radius: 4px;
        transition: background 0.2s;
    }

    .emoji-item:hover {
        background: #f0f0f0;
        transform: scale(1.2);
    }

    .message-actions {
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 0.5rem;
        display: flex;
        gap: 0.5rem;
        z-index: 500;
    }

    .message-action-btn {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 4px;
        transition: background 0.2s;
    }

    .message-action-btn:hover {
        background: #f0f0f0;
    }

    .message-wrapper {
        position: relative;
        display: inline-flex;
        flex-direction: column;
    }


</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4"><i class="bi bi-chat-dots"></i> –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h1>
    
    <div class="messenger-container">
        <!-- –°–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ -->
        <div class="conversations-list">
            <div class="conversations-header">
                <i class="bi bi-people"></i> –î–∏–∞–ª–æ–≥–∏
            </div>
            
            <!-- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            <div style="padding: 0.75rem; border-bottom: 1px solid #e0e0e0;">
                <input type="text" id="userSearch" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∏–∫–Ω–µ–π–º—É..." 
                       style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
                       onkeyup="searchUsers(this.value)">
                <div id="searchResults" style="margin-top: 0.5rem; max-height: 200px; overflow-y: auto; display: none;"></div>
            </div>
            
            {% if conversations %}
                {% for conv in conversations %}
                <div class="conversation-item" data-user-id="{{ conv.user.id }}" data-username="{{ conv.user.username }}" onclick="loadConversation({{ conv.user.id }}, this.dataset.username)">
                    <div class="conversation-info">
                        <div class="conversation-username">{{ conv.user.nickname or conv.user.username }} (@{{ conv.user.nickname or conv.user.username }})</div>
                        {% if conv.last_message %}
                            <div class="conversation-preview">
                                {% if conv.last_message.sender_id == current_user.id %}
                                    <strong>–í—ã:</strong> 
                                {% endif %}
                                {{ conv.last_message.content[:50] }}{% if conv.last_message.content|length > 50 %}...{% endif %}
                            </div>
                            <div class="conversation-time">
                                {{ conv.last_message.created_at.strftime('%d.%m.%Y %H:%M') }}
                            </div>
                        {% else %}
                            <div class="conversation-preview" style="color: #999;">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>
                        {% endif %}
                    </div>
                    {% if conv.unread_count > 0 %}
                        <span class="unread-badge">{{ conv.unread_count }}</span>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="no-conversations">
                    <p>–ù–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤</p>
                    <p style="font-size: 0.9rem;">–ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥, –≤—ã–±—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</p>
                </div>
            {% endif %}
        </div>
        
        <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
        <div class="chat-area">
            <div class="chat-header" id="chatHeader">
                <span id="chatUserName">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥</span>
                <div style="margin-left: auto;">
                    <button class="btn btn-sm btn-primary" id="callBtn" onclick="startAudioCall()" style="display: none;">
                        <i class="bi bi-telephone-fill"></i> –ó–≤–æ–Ω–æ–∫
                    </button>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="empty-chat">
                    –í—ã–±–µ—Ä–∏—Ç–µ –¥–∏–∞–ª–æ–≥ –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è
                </div>
            </div>
            
            <div class="chat-input-area" id="chatInputArea" style="display: none;">
                <div style="width: 100%; display: flex; flex-direction: column; gap: 0.5rem;">
                    <div id="fileAttachmentDisplay" style="display: none;">
                        <div class="file-attachment-display">
                            <i id="fileAttachmentIcon" class="bi bi-file-earmark"></i>
                            <div class="file-attachment-info">
                                <div class="file-attachment-name" id="fileAttachmentName"></div>
                                <div class="file-attachment-size" id="fileAttachmentSize"></div>
                            </div>
                            <button class="file-attachment-remove" onclick="clearFileSelection()">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                        <input type="text" class="chat-input" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleKeyPress(event)">
                        <input type="file" id="fileInput" style="display: none;" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" onchange="handleFileSelect()">
                        <button class="emoji-picker-btn" title="–°–º–∞–π–ª–∏–∫" onclick="toggleEmojiPicker()">üòä</button>
                        <button class="send-btn" onclick="document.getElementById('fileInput').click()" id="attachBtn" style="padding: 0.75rem 1rem;" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª –∏–ª–∏ —Ñ–æ—Ç–æ">
                            <i class="bi bi-paperclip"></i>
                        </button>
                        <button class="send-btn" onclick="sendMessage()" id="sendBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">
                            <i class="bi bi-send"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –≠–º–æ–¥–∑–∏ –ø–∏–∫–µ—Ä –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–µ–∞–∫—Ü–∏–π -->
            <div id="emojiPickerForReactions" class="emoji-picker">
                <div class="emoji-picker-header">
                    <span>–í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ–¥–∑–∏</span>
                    <button class="emoji-picker-close" onclick="closeReactionPicker()">‚úï</button>
                </div>
                <div class="emoji-grid" id="reactionEmojiGrid">
                    <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ JavaScript -->
                </div>
            </div>
            
            <!-- –≠–º–æ–¥–∑–∏ –ø–∏–∫–µ—Ä –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ —Ç–µ–∫—Å—Ç -->
            <div id="emojiPickerForText" class="emoji-picker">
                <div class="emoji-picker-header">
                    <span>–í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ–¥–∑–∏</span>
                    <button class="emoji-picker-close" onclick="closeEmojiPicker()">‚úï</button>
                </div>
                <div class="emoji-grid" id="textEmojiGrid">
                    <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const CURRENT_USER_ID = {{ current_user.id }};
let currentUserId = null;
let currentUserName = null;
let messageInterval = null;

function loadConversation(userId, userName) {
    currentUserId = userId;
    currentUserName = userName;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
    });
    const existingItem = document.querySelector(`[data-user-id="${userId}"]`);
    if (existingItem) {
        existingItem.classList.add('active');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const chatHeader = document.getElementById('chatHeader');
    chatHeader.innerHTML = `
        <span><i class="bi bi-person-circle"></i> ${userName}</span>
        <div style="margin-left: auto;">
            <button class="btn btn-sm btn-primary" id="callBtn" onclick="startAudioCall()">
                <i class="bi bi-telephone-fill"></i> –ó–≤–æ–Ω–æ–∫
            </button>
        </div>
    `;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –≤–≤–æ–¥–∞
    document.getElementById('chatInputArea').style.display = 'flex';
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
    fetch(`/api/messenger/conversation/${userId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayMessages(data.messages);
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ (—É–±–∏—Ä–∞–µ–º badge –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö)
                updateConversationList();
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
        });
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
    if (messageInterval) {
        clearInterval(messageInterval);
    }
    messageInterval = setInterval(() => {
        if (currentUserId) {
            fetch(`/api/messenger/conversation/${currentUserId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayMessages(data.messages);
                    }
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error));
        }
    }, 3000);
}

function displayMessages(messages) {
    const messagesContainer = document.getElementById('chatMessages');
    
    if (messages.length === 0) {
        messagesContainer.innerHTML = '<div class="empty-chat">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥!</div>';
        return;
    }
    
    messagesContainer.innerHTML = '';
    
    messages.forEach(msg => {
        const isSent = msg.sender_id === CURRENT_USER_ID;
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
        
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble';
        bubble.style.maxWidth = msg.message_type === 'photo' ? '300px' : '70%';
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
        if (msg.message_type === 'photo' && msg.file_path) {
            // –§–æ—Ç–æ
            const img = document.createElement('img');
            img.src = msg.file_path;
            img.style.maxWidth = '100%';
            img.style.borderRadius = '8px';
            img.style.cursor = 'pointer';
            img.onclick = () => window.open(msg.file_path, '_blank');
            bubble.appendChild(img);
        } else if (msg.message_type === 'file' && msg.file_path) {
            // –§–∞–π–ª
            const fileName = msg.file_path.split('/').pop().substring(16); // –£–±–∏—Ä–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É
            const fileExt = fileName.split('.').pop().toLowerCase();
            const fileIcon = getFileIcon(fileExt);
            
            const fileDiv = document.createElement('div');
            fileDiv.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.2); border-radius: 8px;';
            
            const icon = document.createElement('i');
            icon.className = fileIcon;
            icon.style.fontSize = '1.5rem';
            
            const fileInfo = document.createElement('div');
            fileInfo.style.flex = '1';
            fileInfo.innerHTML = `
                <div style="font-weight: bold; word-break: break-word;">${fileName}</div>
            `;
            
            const downloadBtn = document.createElement('a');
            downloadBtn.href = msg.file_path;
            downloadBtn.download = fileName;
            downloadBtn.className = 'btn btn-sm btn-light';
            downloadBtn.innerHTML = '<i class="bi bi-download"></i>';
            downloadBtn.style.marginLeft = '0.5rem';
            
            fileDiv.appendChild(icon);
            fileDiv.appendChild(fileInfo);
            fileDiv.appendChild(downloadBtn);
            bubble.appendChild(fileDiv);
        } else if (msg.message_type === 'call') {
            // –ó–≤–æ–Ω–æ–∫
            bubble.textContent = 'üìû ' + msg.content;
            bubble.style.fontStyle = 'italic';
        } else {
            // –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            bubble.textContent = msg.content;
        }
        
        const time = document.createElement('div');
        time.className = 'message-time';
        const msgDate = new Date(msg.created_at);
        time.textContent = msgDate.toLocaleString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        messageDiv.appendChild(bubble);
        messageDiv.appendChild(time);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∞–∫—Ü–∏–∏ untuk —Å–æ–æ–±—â–µ–Ω–∏—è
        loadMessageReactions(msg.id, messageDiv);
        
        messagesContainer.appendChild(messageDiv);
    });
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function getFileIcon(ext) {
    const icons = {
        'pdf': 'bi bi-file-pdf',
        'doc': 'bi bi-file-word',
        'docx': 'bi bi-file-word',
        'xls': 'bi bi-file-excel',
        'xlsx': 'bi bi-file-excel',
        'txt': 'bi bi-file-text',
        'jpg': 'bi bi-file-image',
        'png': 'bi bi-file-image',
        'jpeg': 'bi bi-file-image',
        'zip': 'bi bi-file-zip',
        'rar': 'bi bi-file-zip'
    };
    return icons[ext] || 'bi bi-file-earmark';
}

let selectedFile = null;

function handleFileSelect() {
    const fileInput = document.getElementById('fileInput');
    selectedFile = fileInput.files[0] || null;
    
    if (selectedFile) {
        const fileAttachmentDisplay = document.getElementById('fileAttachmentDisplay');
        const fileName = selectedFile.name;
        const fileSize = (selectedFile.size / 1024).toFixed(2);
        const fileExt = fileName.split('.').pop().toLowerCase();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
        const fileIcon = document.getElementById('fileAttachmentIcon');
        fileIcon.className = getFileIcon(fileExt).replace('bi bi-', 'bi bi-') || 'bi bi-file-earmark';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
        document.getElementById('fileAttachmentName').textContent = fileName;
        document.getElementById('fileAttachmentSize').textContent = `${fileSize} KB`;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ñ–∞–π–ª–µ
        fileAttachmentDisplay.style.display = 'block';
    }
}

function clearFileSelection() {
    selectedFile = null;
    document.getElementById('fileInput').value = '';
    document.getElementById('fileAttachmentDisplay').style.display = 'none';
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const content = input.value.trim();
    
    if (!content && !selectedFile && !currentUserId) {
        return;
    }
    
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    
    if (selectedFile) {
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞
        const formData = new FormData();
        formData.append('receiver_id', currentUserId);
        formData.append('file', selectedFile);
        formData.append('message', content || `–§–∞–π–ª: ${selectedFile.name}`);
        
        const isImage = selectedFile.type.startsWith('image/');
        const fileName = selectedFile.name;
        
        fetch('/api/messenger/send', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                input.value = '';
                clearFileSelection();
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª–æ–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
                const messagesContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message sent';
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.style.maxWidth = isImage ? '300px' : '70%';
                
                if (isImage) {
                    const img = document.createElement('img');
                    img.src = data.message.file_path;
                    img.style.maxWidth = '100%';
                    img.style.borderRadius = '8px';
                    img.style.cursor = 'pointer';
                    img.onclick = () => window.open(data.message.file_path, '_blank');
                    bubble.appendChild(img);
                } else {
                    const filePathName = data.message.file_path.split('/').pop().substring(16);
                    const fileExt = filePathName.split('.').pop().toLowerCase();
                    const fileIcon = getFileIcon(fileExt);
                    
                    const fileDiv = document.createElement('div');
                    fileDiv.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.2); border-radius: 8px;';
                    
                    const icon = document.createElement('i');
                    icon.className = fileIcon;
                    icon.style.fontSize = '1.5rem';
                    
                    const fileInfo = document.createElement('div');
                    fileInfo.style.flex = '1';
                    fileInfo.innerHTML = `<div style="font-weight: bold; word-break: break-word;">${filePathName}</div>`;
                    
                    const downloadBtn = document.createElement('a');
                    downloadBtn.href = data.message.file_path;
                    downloadBtn.download = filePathName;
                    downloadBtn.className = 'btn btn-sm btn-light';
                    downloadBtn.innerHTML = '<i class="bi bi-download"></i>';
                    downloadBtn.style.marginLeft = '0.5rem';
                    
                    fileDiv.appendChild(icon);
                    fileDiv.appendChild(fileInfo);
                    fileDiv.appendChild(downloadBtn);
                    bubble.appendChild(fileDiv);
                }
                
                const time = document.createElement('div');
                time.className = 'message-time';
                const now = new Date();
                time.textContent = now.toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                messageDiv.appendChild(bubble);
                messageDiv.appendChild(time);
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                updateConversationPreview(currentUserId, `–§–∞–π–ª: ${fileName}`);
            } else {
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞');
        })
        .finally(() => {
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="bi bi-send"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å';
        });
    } else {
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        if (!content) {
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="bi bi-send"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å';
            return;
        }
        
        fetch('/api/messenger/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                receiver_id: currentUserId,
                content: content
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                input.value = '';
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É –≤ —á–∞—Ç
                const messagesContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message sent';
                
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble';
                bubble.textContent = content;
                
                const time = document.createElement('div');
                time.className = 'message-time';
                const now = new Date();
                time.textContent = now.toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                messageDiv.appendChild(bubble);
                messageDiv.appendChild(time);
                messagesContainer.appendChild(messageDiv);
                
                // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                updateConversationPreview(currentUserId, content);
            } else {
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
        })
        .finally(() => {
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="bi bi-send"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å';
        });
    }
}

function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function updateConversationList() {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
    fetch('/api/messenger/unread-count')
        .then(response => response.json())
        .then(data => {
            // –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å badge –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        });
}

function updateConversationPreview(userId, lastMessage) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –ø—Ä–µ–≤—å—é –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    let conversationItem = document.querySelector(`[data-user-id="${userId}"]`);
    const conversationsList = document.querySelector('.conversations-list');

    if (!conversationItem && conversationsList) {
        const newItem = document.createElement('div');
        newItem.className = 'conversation-item';
        newItem.dataset.userId = userId;
        newItem.dataset.username = currentUserName || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫';
        newItem.onclick = () => loadConversation(userId, currentUserName || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫');
        newItem.innerHTML = `
            <div class="conversation-info">
                <div class="conversation-username">${currentUserName || '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫'}</div>
                <div class="conversation-preview" style="color: #666;">–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
                <div class="conversation-time"></div>
            </div>
        `;
        conversationsList.appendChild(newItem);
        const placeholder = document.querySelector('.no-conversations');
        if (placeholder) {
            placeholder.remove();
        }
        conversationItem = newItem;
    }

    if (conversationItem) {
        conversationItem.classList.add('active');
        const preview = conversationItem.querySelector('.conversation-preview');
        if (preview) {
            preview.innerHTML = `<strong>–í—ã:</strong> ${lastMessage.length > 50 ? lastMessage.substring(0, 50) + '...' : lastMessage}`;
        }
        const timeElement = conversationItem.querySelector('.conversation-time');
        if (timeElement) {
            const now = new Date();
            timeElement.textContent = now.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    }
}

function searchUsers(query) {
    const searchResults = document.getElementById('searchResults');
    
    if (query.length < 2) {
        searchResults.style.display = 'none';
        return;
    }
    
    fetch(`/api/messenger/search-users?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.users.length > 0) {
                searchResults.innerHTML = '';
                data.users.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'conversation-item';
                    userDiv.style.cursor = 'pointer';
                    userDiv.innerHTML = `
                        <div class="conversation-info">
                            <div class="conversation-username">${user.nickname || user.username} (@${user.nickname || user.username})</div>
                            <div class="conversation-preview" style="color: #666;">${user.email}</div>
                        </div>
                    `;
                    userDiv.onclick = () => {
                        loadConversation(user.id, user.nickname || user.username);
                        searchResults.style.display = 'none';
                        document.getElementById('userSearch').value = '';
                    };
                    searchResults.appendChild(userDiv);
                });
                searchResults.style.display = 'block';
            } else {
                searchResults.innerHTML = '<div style="padding: 0.5rem; color: #999;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                searchResults.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
        });
}

let localAudioStream = null;
let remoteAudioStream = null;
let peerConnection = null;
let isCallActive = false;

async function checkMicrophonePermission() {
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
        if (navigator.permissions) {
            const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
            console.log('[INFO] –°—Ç–∞—Ç—É—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:', permissionStatus.state);
            
            if (permissionStatus.state === 'denied') {
                throw new Error('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.');
            }
        }
        
        return true;
    } catch (error) {
        console.error('[ERROR] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π:', error);
        throw error;
    }
}

async function requestMicrophoneAccess() {
    try {
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
        await checkMicrophonePermission();
        
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
        const stream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            }, 
            video: false 
        });
        
        return stream;
    } catch (error) {
        console.error('[ERROR] –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
        
        let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.';
        
        if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
            errorMessage = '–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
        } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
            errorMessage = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É.';
        } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
            errorMessage = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º. –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω.';
        } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
            errorMessage = '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–µ–±—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.';
        } else if (error.name === 'TypeError') {
            errorMessage = '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä (Chrome, Firefox, Edge).';
        }
        
        throw { message: errorMessage, originalError: error };
    }
}

function startAudioCall() {
    if (!currentUserId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –¥–ª—è –∑–≤–æ–Ω–∫–∞');
        return;
    }
    
    if (isCallActive) {
        alert('–ó–≤–æ–Ω–æ–∫ —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω');
        return;
    }
    
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∞—É–¥–∏–æ –∑–≤–æ–Ω–∫–∞
    const callModal = document.createElement('div');
    callModal.id = 'audioCallModal';
    callModal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 10000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    `;
    
    callModal.innerHTML = `
        <div style="background: #fff; padding: 3rem; border-radius: 12px; max-width: 500px; width: 90%; text-align: center;">
            <div style="width: 150px; height: 150px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0 auto 2rem; display: flex; align-items: center; justify-content: center; font-size: 4rem; color: white;">
                <i class="bi bi-person-circle"></i>
            </div>
            <h3 style="margin-bottom: 0.5rem;">–ó–≤–æ–Ω–æ–∫ —Å ${currentUserName}</h3>
            <p id="callStatus" style="color: #666; margin-bottom: 2rem;">
                <i class="bi bi-hourglass-split"></i> –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...
            </p>
            <div id="permissionRequest" style="margin-bottom: 1rem;">
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
                    –î–ª—è –∑–≤–æ–Ω–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ù–∞–∂–º–∏—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å" –≤ –∑–∞–ø—Ä–æ—Å–µ –±—Ä–∞—É–∑–µ—Ä–∞.
                </p>
                <button class="btn btn-primary" id="requestPermissionBtn" onclick="requestMicrophoneForCall()" style="padding: 0.75rem 1.5rem;">
                    <i class="bi bi-mic"></i> –ó–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                </button>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                <button class="btn btn-success btn-lg" id="startCallBtn" onclick="initiateAudioCall()" style="padding: 1rem 2rem; display: none;">
                    <i class="bi bi-telephone-fill"></i> –ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫
                </button>
                <button class="btn btn-danger btn-lg" onclick="endAudioCall()" style="padding: 1rem 2rem;">
                    <i class="bi bi-x-circle"></i> –û—Ç–º–µ–Ω–∏—Ç—å
                </button>
            </div>
            <div id="callControls" style="display: none; margin-top: 2rem;">
                <button class="btn btn-warning" id="muteBtn" onclick="toggleMute()" style="margin-right: 1rem;">
                    <i class="bi bi-mic"></i> <span id="muteText">–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</span>
                </button>
                <button class="btn btn-danger" onclick="endAudioCall()">
                    <i class="bi bi-telephone-x"></i> –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫
                </button>
            </div>
            <div id="errorMessage" style="display: none; margin-top: 1rem; padding: 1rem; background: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33;"></div>
            <audio id="remoteAudio" autoplay style="display: none;"></audio>
        </div>
    `;
    
    document.body.appendChild(callModal);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
    requestMicrophoneForCall();
}

async function requestMicrophoneForCall() {
    const statusEl = document.getElementById('callStatus');
    const permissionRequest = document.getElementById('permissionRequest');
    const requestBtn = document.getElementById('requestPermissionBtn');
    const startCallBtn = document.getElementById('startCallBtn');
    const errorMessage = document.getElementById('errorMessage');
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏
    errorMessage.style.display = 'none';
    errorMessage.textContent = '';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    statusEl.innerHTML = '<i class="bi bi-hourglass-split"></i> –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...';
    requestBtn.disabled = true;
    requestBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> –ó–∞–ø—Ä–æ—Å...';
    
    try {
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
        localAudioStream = await requestMicrophoneAccess();
        
        // –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–∏–ª–∏ –¥–æ—Å—Ç—É–ø
        statusEl.innerHTML = '<i class="bi bi-check-circle" style="color: #10b981;"></i> –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω';
        statusEl.style.color = '#10b981';
        permissionRequest.style.display = 'none';
        startCallBtn.style.display = 'inline-block';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        const audioTracks = localAudioStream.getAudioTracks();
        if (audioTracks.length > 0) {
            console.log('[OK] –ú–∏–∫—Ä–æ—Ñ–æ–Ω –ø–æ–¥–∫–ª—é—á–µ–Ω:', audioTracks[0].label);
            console.log('[INFO] –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:', {
                echoCancellation: audioTracks[0].getSettings().echoCancellation,
                noiseSuppression: audioTracks[0].getSettings().noiseSuppression,
                autoGainControl: audioTracks[0].getSettings().autoGainControl
            });
        }
        
    } catch (error) {
        // –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞
        console.error('[ERROR] –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
        
        statusEl.innerHTML = '<i class="bi bi-x-circle" style="color: #ef4444;"></i> –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
        statusEl.style.color = '#ef4444';
        
        errorMessage.textContent = error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É';
        errorMessage.style.display = 'block';
        
        requestBtn.disabled = false;
        requestBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞';
        startCallBtn.style.display = 'none';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        const browserInstructions = getBrowserInstructions();
        if (browserInstructions) {
            errorMessage.innerHTML += '<br><br><strong>–ö–∞–∫ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø:</strong><br>' + browserInstructions;
        }
    }
}

function getBrowserInstructions() {
    const userAgent = navigator.userAgent.toLowerCase();
    
    if (userAgent.includes('chrome')) {
        return 'Chrome: –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É –∑–∞–º–∫–∞ –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ ‚Üí –†–∞–∑—Ä–µ—à–µ–Ω–∏—è ‚Üí –ú–∏–∫—Ä–æ—Ñ–æ–Ω ‚Üí –†–∞–∑—Ä–µ—à–∏—Ç—å';
    } else if (userAgent.includes('firefox')) {
        return 'Firefox: –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É –∑–∞–º–∫–∞ –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ ‚Üí –†–∞–∑—Ä–µ—à–µ–Ω–∏—è ‚Üí –ú–∏–∫—Ä–æ—Ñ–æ–Ω ‚Üí –†–∞–∑—Ä–µ—à–∏—Ç—å';
    } else if (userAgent.includes('edge')) {
        return 'Edge: –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É –∑–∞–º–∫–∞ –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ ‚Üí –†–∞–∑—Ä–µ—à–µ–Ω–∏—è ‚Üí –ú–∏–∫—Ä–æ—Ñ–æ–Ω ‚Üí –†–∞–∑—Ä–µ—à–∏—Ç—å';
    } else if (userAgent.includes('safari')) {
        return 'Safari: Safari ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –í–µ–±-—Å–∞–π—Ç—ã ‚Üí –ú–∏–∫—Ä–æ—Ñ–æ–Ω ‚Üí –†–∞–∑—Ä–µ—à–∏—Ç—å –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞';
    }
    
    return '–û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞';
}

function initiateAudioCall() {
    if (!localAudioStream) {
        alert('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.');
        requestMicrophoneForCall();
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω –≤—Å–µ –µ—â–µ –∞–∫—Ç–∏–≤–µ–Ω
    const audioTracks = localAudioStream.getAudioTracks();
    if (audioTracks.length === 0 || audioTracks[0].readyState !== 'live') {
        alert('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø —Å–Ω–æ–≤–∞.');
        requestMicrophoneForCall();
        return;
    }
    
    isCallActive = true;
    document.getElementById('callStatus').textContent = '–ó–≤–æ–Ω–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω';
    document.getElementById('startCallBtn').style.display = 'none';
    document.getElementById('callControls').style.display = 'block';
    
    // –°–æ–∑–¥–∞–µ–º RTCPeerConnection –¥–ª—è WebRTC
    const configuration = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
        ]
    };
    
    peerConnection = new RTCPeerConnection(configuration);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫
    localAudioStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localAudioStream);
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫–∞
    peerConnection.ontrack = (event) => {
        remoteAudioStream = event.streams[0];
        const remoteAudio = document.getElementById('remoteAudio');
        remoteAudio.srcObject = remoteAudioStream;
        console.log('[OK] –ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª–µ–Ω–Ω—ã–π –∞—É–¥–∏–æ –ø–æ—Ç–æ–∫');
    };
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
    peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
            console.log('[INFO] ICE –∫–∞–Ω–¥–∏–¥–∞—Ç:', event.candidate);
            // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ —á–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
        }
    };
    
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (offer)
    peerConnection.createOffer()
        .then(offer => {
            return peerConnection.setLocalDescription(offer);
        })
        .then(() => {
            console.log('[OK] Offer —Å–æ–∑–¥–∞–Ω');
            // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∞ offer —á–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
            // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            document.getElementById('callStatus').textContent = '–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...';
        })
        .catch(error => {
            console.error('[ERROR] –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer:', error);
            alert('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            endAudioCall();
        });
    
    // –°–∏–º—É–ª—è—Ü–∏—è: —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã "–ø–æ–¥–∫–ª—é—á–∞–µ–º" —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫
    setTimeout(() => {
        if (isCallActive) {
            document.getElementById('callStatus').textContent = '–ó–≤–æ–Ω–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è
        }
    }, 2000);
}

function toggleMute() {
    if (!localAudioStream) return;
    
    const audioTracks = localAudioStream.getAudioTracks();
    if (audioTracks.length > 0) {
        const isMuted = !audioTracks[0].enabled;
        audioTracks[0].enabled = isMuted;
        
        const muteBtn = document.getElementById('muteBtn');
        const muteText = document.getElementById('muteText');
        
        if (isMuted) {
            muteBtn.classList.remove('btn-warning');
            muteBtn.classList.add('btn-secondary');
            muteText.textContent = '–í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω';
        } else {
            muteBtn.classList.remove('btn-secondary');
            muteBtn.classList.add('btn-warning');
            muteText.textContent = '–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω';
        }
    }
}

function endAudioCall() {
    isCallActive = false;
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
    if (localAudioStream) {
        localAudioStream.getTracks().forEach(track => track.stop());
        localAudioStream = null;
    }
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º peer connection
    if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
    }
    
    // –£–¥–∞–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = document.getElementById('audioCallModal');
    if (modal) {
        modal.remove();
    }
    
    console.log('[INFO] –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
}

// ===== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –†–ï–ê–ö–¶–ò–Ø–ú–ò –ò –≠–ú–û–î–ó–ò =====

const POPULAR_EMOJIS = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üî•', 'üíØ', 'üéâ', 'üòç', 'üôè', 'üòé', 'ü§î', 'üëè', '‚ú®', 'üéà', 'üí™'];

function loadMessageReactions(messageId, messageElement) {
    fetch(`/api/messenger/message/${messageId}/reactions`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.reactions && data.reactions.length > 0) {
                const reactionsContainer = document.createElement('div');
                reactionsContainer.className = 'message-reactions';
                
                data.reactions.forEach(reaction => {
                    const reactionBtn = document.createElement('button');
                    reactionBtn.className = `reaction-button ${reaction.current_user_reacted ? 'active' : ''}`;
                    reactionBtn.innerHTML = `<span>${reaction.emoji}</span><span class="reaction-count">${reaction.count}</span>`;
                    reactionBtn.onclick = (e) => {
                        e.stopPropagation();
                        addReaction(messageId, reaction.emoji);
                    };
                    reactionBtn.title = `–†–µ–∞–∫—Ü–∏–∏: ${reaction.users.map(u => u.nickname).join(', ')}`;
                    reactionsContainer.appendChild(reactionBtn);
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–∏
                const addReactionBtn = document.createElement('button');
                addReactionBtn.className = 'reaction-button';
                addReactionBtn.textContent = '+';
                addReactionBtn.onclick = (e) => {
                    e.stopPropagation();
                    showReactionPicker(messageId, addReactionBtn);
                };
                reactionsContainer.appendChild(addReactionBtn);
                
                // –î–æ–±–∞–≤–ª—è–µ–º hover –¥–ª—è –ø–æ–∫–∞–∑–∞ –¥–µ–π—Å—Ç–≤–∏–π —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
                messageElement.addEventListener('mouseenter', () => {
                    messageElement.style.position = 'relative';
                });
                
                messageElement.appendChild(reactionsContainer);
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∞–∫—Ü–∏–π, –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
                const reactionsContainer = document.createElement('div');
                reactionsContainer.className = 'message-reactions';
                
                const addReactionBtn = document.createElement('button');
                addReactionBtn.className = 'reaction-button';
                addReactionBtn.textContent = '+';
                addReactionBtn.onclick = (e) => {
                    e.stopPropagation();
                    showReactionPicker(messageId, addReactionBtn);
                };
                reactionsContainer.appendChild(addReactionBtn);
                messageElement.appendChild(reactionsContainer);
            }
        })
        .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∞–∫—Ü–∏–π:', error));
}

function showReactionPicker(messageId, buttonElement) {
    const picker = document.getElementById('emojiPickerForReactions');
    
    // –ò–∑–º–µ–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–∏–∫–µ—Ä–∞
    const rect = buttonElement.getBoundingClientRect();
    picker.style.position = 'fixed';
    picker.style.top = (rect.top - 380) + 'px';
    picker.style.left = (rect.left - 150) + 'px';
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —ç–º–æ–¥–∑–∏
    const grid = document.getElementById('reactionEmojiGrid');
    grid.innerHTML = '';
    
    POPULAR_EMOJIS.forEach(emoji => {
        const item = document.createElement('button');
        item.className = 'emoji-item';
        item.textContent = emoji;
        item.onclick = () => {
            addReaction(messageId, emoji);
            picker.classList.remove('active');
        };
        grid.appendChild(item);
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∏–∫–µ—Ä
    picker.classList.add('active');
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–∏–∫–µ—Ä–∞
    setTimeout(() => {
        document.addEventListener('click', function closeOnClick(e) {
            if (!picker.contains(e.target) && e.target !== buttonElement) {
                picker.classList.remove('active');
                document.removeEventListener('click', closeOnClick);
            }
        });
    }, 100);
}

function closeReactionPicker() {
    document.getElementById('emojiPickerForReactions').classList.remove('active');
}

function addReaction(messageId, emoji) {
    fetch('/api/messenger/reaction/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message_id: messageId,
            emoji: emoji
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && currentUserId) {
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–π
            fetch(`/api/messenger/conversation/${currentUserId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayMessages(data.messages);
                    }
                });
        }
    })
    .catch(error => console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–∏:', error));
}

function toggleEmojiPicker() {
    const picker = document.getElementById('emojiPickerForText');
    
    if (!picker.classList.contains('active')) {
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —ç–º–æ–¥–∑–∏
        const grid = document.getElementById('textEmojiGrid');
        grid.innerHTML = '';
        
        POPULAR_EMOJIS.forEach(emoji => {
            const item = document.createElement('button');
            item.className = 'emoji-item';
            item.textContent = emoji;
            item.onclick = () => {
                insertEmojiToInput(emoji);
                picker.classList.remove('active');
            };
            grid.appendChild(item);
        });
        
        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –ø–∏–∫–µ—Ä
        const messageInputArea = document.querySelector('.chat-input-area');
        if (messageInputArea) {
            const rect = messageInputArea.getBoundingClientRect();
            picker.style.position = 'fixed';
            picker.style.top = (rect.top - 400) + 'px';
            picker.style.left = (rect.left + 50) + 'px';
        }
        
        picker.classList.add('active');
    } else {
        picker.classList.remove('active');
    }
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–∏–∫–µ—Ä–∞
    setTimeout(() => {
        document.addEventListener('click', function closeOnClick(e) {
            if (!picker.contains(e.target)) {
                picker.classList.remove('active');
                document.removeEventListener('click', closeOnClick);
            }
        });
    }, 100);
}

function closeEmojiPicker() {
    document.getElementById('emojiPickerForText').classList.remove('active');
}

function insertEmojiToInput(emoji) {
    const input = document.getElementById('messageInput');
    const cursorPos = input.selectionStart;
    const textBefore = input.value.substring(0, cursorPos);
    const textAfter = input.value.substring(cursorPos);
    
    input.value = textBefore + emoji + textAfter;
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
    const newCursorPos = cursorPos + emoji.length;
    input.selectionStart = newCursorPos;
    input.selectionEnd = newCursorPos;
    input.focus();
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    updateConversationList();
    setInterval(updateConversationList, 10000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏
    document.addEventListener('click', function(e) {
        const searchResults = document.getElementById('searchResults');
        const userSearch = document.getElementById('userSearch');
        if (searchResults && userSearch && !searchResults.contains(e.target) && !userSearch.contains(e.target)) {
            searchResults.style.display = 'none';
        }
    });
});
</script>
{% endblock %}

