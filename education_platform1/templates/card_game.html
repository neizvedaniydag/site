{% extends "base.html" %}

{% block title %}–ò–≥—Ä–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–∏{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2>üéÆ –ò–≥—Ä–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–∏</h2>
            <p class="text-muted">–°–æ–∑–¥–∞–π—Ç–µ –∏–≥—Ä—É, –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∑–Ω–∞–Ω–∏—è –¥—Ä—É–≥ –¥—Ä—É–≥–∞!</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('create_card_game') }}" class="btn btn-primary btn-lg">
                <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É
            </a>
        </div>
    </div>

    <!-- –ö–∞–∫ –∏–≥—Ä–∞—Ç—å -->
    <div class="card mb-4 border-info">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-info-circle"></i> –ö–∞–∫ –∏–≥—Ä–∞—Ç—å?</h5>
        </div>
        <div class="card-body">
            <ol class="mb-0">
                <li><strong>–°–æ–∑–¥–∞–π—Ç–µ –∏–≥—Ä—É</strong> - –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª</li>
                <li><strong>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–∑–µ–π</strong> - –¥–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</li>
                <li><strong>–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏</strong> - –ò–ò —Å–æ–∑–¥–∞—Å—Ç –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã</li>
                <li><strong>–ù–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É</strong> - –∫–∞—Ä—Ç–æ—á–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—Å—è —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º</li>
                <li><strong>–û—Ç–≤–µ—á–∞–π—Ç–µ</strong> - –∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ —Å–≤–æ–∏ –≤–æ–ø—Ä–æ—Å—ã</li>
                <li><strong>–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ç–æ–≤–∞—Ä–∏—â–µ–π</strong> - –≤–∏–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç, –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ –æ—Ç–≤–µ—Ç –¥—Ä—É–≥–∞</li>
            </ol>
        </div>
    </div>

    <!-- ‚≠ê –ù–û–í–ê–Ø –°–ï–ö–¶–ò–Ø: –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è -->
    {% if invited_sessions %}
    <div class="card mb-4 border-warning">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="fas fa-envelope"></i> –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è ({{ invited_sessions|length }})</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for session in invited_sessions %}
                <div class="col-md-6 mb-3">
                    <div class="card h-100 border-warning shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">{{ session.title }}</h5>
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-clock"></i> –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
                                </span>
                            </div>
                            <p class="card-text">
                                <strong><i class="fas fa-user"></i> –û—Ç:</strong> {{ session.creator.nickname or session.creator.username }}<br>
                                <strong><i class="fas fa-book"></i> –ü—Ä–µ–¥–º–µ—Ç:</strong> {{ session.subject }}<br>
                                <strong><i class="fas fa-bookmark"></i> –¢–µ–º–∞:</strong> {{ session.topic }}<br>
                                <strong><i class="fas fa-users"></i> –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> {{ session.participants|length }}
                            </p>
                            <p class="text-muted small mb-3">
                                <i class="far fa-clock"></i> –°–æ–∑–¥–∞–Ω–æ: {{ session.created_at.strftime('%d.%m.%Y %H:%M') }}
                            </p>
                            <div class="d-flex gap-2">
                                <button class="btn btn-success btn-sm" onclick="acceptInvite({{ session.id }})">
                                    <i class="fas fa-check"></i> –ü—Ä–∏–Ω—è—Ç—å
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="declineInvite({{ session.id }})">
                                    <i class="fas fa-times"></i> –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                </button>
                                <a href="{{ url_for('view_card_game_session', session_id=session.id) }}" class="btn btn-info btn-sm">
                                    <i class="fas fa-eye"></i> –°–º–æ—Ç—Ä–µ—Ç—å
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- –ú–æ–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-gamepad"></i> –ú–æ–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã</h5>
        </div>
        <div class="card-body">
            {% if my_sessions %}
                <div class="row">
                    {% for session in my_sessions %}
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 {% if session.status == 'waiting' %}border-warning{% elif session.status == 'in_progress' %}border-success{% else %}border-secondary{% endif %}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0">{{ session.title }}</h5>
                                    <span class="badge 
                                        {% if session.status == 'waiting' %}bg-warning text-dark
                                        {% elif session.status == 'in_progress' %}bg-success
                                        {% else %}bg-secondary{% endif %}">
                                        {% if session.status == 'waiting' %}–û–∂–∏–¥–∞–Ω–∏–µ
                                        {% elif session.status == 'in_progress' %}–í –∏–≥—Ä–µ
                                        {% else %}–ó–∞–≤–µ—Ä—à–µ–Ω–∞{% endif %}
                                    </span>
                                </div>
                                <p class="card-text">
                                    <strong>–ü—Ä–µ–¥–º–µ—Ç:</strong> {{ session.subject }}<br>
                                    <strong>–¢–µ–º–∞:</strong> {{ session.topic }}<br>
                                    <strong>–ö–∞—Ä—Ç–æ—á–µ–∫:</strong> {{ session.cards|length }}/{{ session.num_cards }}<br>
                                    <strong>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> {{ session.participants|length }}
                                </p>
                                <p class="text-muted small">
                                    <i class="far fa-clock"></i> –°–æ–∑–¥–∞–Ω–æ: {{ session.created_at.strftime('%d.%m.%Y %H:%M') }}
                                </p>
                                <div class="d-flex gap-2">
                                    <a href="{{ url_for('view_card_game_session', session_id=session.id) }}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-eye"></i> –û—Ç–∫—Ä—ã—Ç—å
                                    </a>
                                    {% if session.status == 'in_progress' %}
                                    <a href="{{ url_for('play_card_game', session_id=session.id) }}" class="btn btn-sm btn-success">
                                        <i class="fas fa-play"></i> –ò–≥—Ä–∞—Ç—å
                                    </a>
                                    {% endif %}
                                    <button class="btn btn-sm btn-danger" onclick="deleteSession({{ session.id }})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted text-center py-4">
                    <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                    –í—ã –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–ª–∏ –Ω–∏ –æ–¥–Ω–æ–π –∏–≥—Ä—ã. –ù–∞—á–Ω–∏—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!
                </p>
            {% endif %}
        </div>
    </div>

    <!-- –ò–≥—Ä—ã, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —è —É—á–∞—Å—Ç–≤—É—é -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-users"></i> –ò–≥—Ä—ã —Å –¥—Ä—É–∑—å—è–º–∏</h5>
        </div>
        <div class="card-body">
            {% if joined_sessions %}
                <div class="row">
                    {% for session in joined_sessions %}
                    <div class="col-md-6 mb-3">
                        <div class="card h-100 border-info">
                            <div class="card-body">
                                <h5 class="card-title">{{ session.title }}</h5>
                                <p class="card-text">
                                    <strong>–°–æ–∑–¥–∞—Ç–µ–ª—å:</strong> {{ session.creator.nickname or session.creator.username }}<br>
                                    <strong>–¢–µ–º–∞:</strong> {{ session.topic }}<br>
                                    <strong>–°—Ç–∞—Ç—É—Å:</strong> 
                                    <span class="badge 
                                        {% if session.status == 'waiting' %}bg-warning text-dark
                                        {% elif session.status == 'in_progress' %}bg-success
                                        {% else %}bg-secondary{% endif %}">
                                        {% if session.status == 'waiting' %}–û–∂–∏–¥–∞–Ω–∏–µ
                                        {% elif session.status == 'in_progress' %}–í –∏–≥—Ä–µ
                                        {% else %}–ó–∞–≤–µ—Ä—à–µ–Ω–∞{% endif %}
                                    </span>
                                </p>
                                <div class="d-flex gap-2">
                                    <a href="{{ url_for('view_card_game_session', session_id=session.id) }}" class="btn btn-sm btn-info">
                                        <i class="fas fa-eye"></i> –°–º–æ—Ç—Ä–µ—Ç—å
                                    </a>
                                    {% if session.status == 'in_progress' %}
                                    <a href="{{ url_for('play_card_game', session_id=session.id) }}" class="btn btn-sm btn-success">
                                        <i class="fas fa-play"></i> –ò–≥—Ä–∞—Ç—å
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted text-center py-4">
                    <i class="fas fa-user-friends fa-3x mb-3 d-block"></i>
                    –í–∞—Å –µ—â–µ –Ω–µ –ø—Ä–∏–≥–ª–∞—à–∞–ª–∏ –≤ –∏–≥—Ä—ã. –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –∏–ª–∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è!
                </p>
            {% endif %}
        </div>
    </div>
</div>

<script>
// ‚≠ê –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü—Ä–∏–Ω—è—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
function acceptInvite(sessionId) {
    fetch(`/api/card-game/session/${sessionId}/accept-invite`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ! –¢–µ–ø–µ—Ä—å –≤—ã —É—á–∞—Å—Ç–Ω–∏–∫ –∏–≥—Ä—ã.');
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(err => alert('–û—à–∏–±–∫–∞: ' + err));
}

// ‚≠ê –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û—Ç–∫–ª–æ–Ω–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
function declineInvite(sessionId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ?')) return;
    
    fetch(`/api/card-game/session/${sessionId}/decline-invite`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('‚ùå –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ');
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(err => alert('–û—à–∏–±–∫–∞: ' + err));
}

function deleteSession(sessionId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∏–≥—Ä—É?')) return;
    
    fetch(`/api/card-game/session/${sessionId}`, {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'}
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('–ò–≥—Ä–∞ —É–¥–∞–ª–µ–Ω–∞!');
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    })
    .catch(err => alert('–û—à–∏–±–∫–∞: ' + err));
}
</script>
{% endblock %}
